const WhatsAppService = require('./whatsappService');
const Order = require('../models/Order');
const Dish = require('../models/Dish');
const WhatsAppOrder = require('../models/WhatsAppOrder');
const moment = require('moment-timezone');

class SimpleOrderBot {
  // Main message handler - keep it simple
  static async handleMessage(phoneNumber, messageBody) {
    try {
      const message = messageBody.toLowerCase().trim();
      console.log(`üì± ${phoneNumber}: "${messageBody}"`);

      // Handle special commands
      if (message === 'menu' || message === 'list') {
        return await SimpleOrderBot.sendMenu(phoneNumber);
      }

      if (message.includes('track') || message.match(/^\d{8}-\d{3}$/)) {
        return await SimpleOrderBot.handleTracking(phoneNumber, message);
      }

      if (message === 'hi' || message === 'hello' || message === 'start') {
        return await SimpleOrderBot.sendWelcome(phoneNumber);
      }

      // Try to parse as order
      const orderItems = await SimpleOrderBot.parseSimpleOrder(message);
      if (orderItems.length > 0) {
        return await SimpleOrderBot.handleOrder(phoneNumber, orderItems);
      }

      // Default response
      return await SimpleOrderBot.sendHelp(phoneNumber);

    } catch (error) {
      console.error('Error in handleMessage:', error);
      await WhatsAppService.sendMessage(
        phoneNumber,
        '‚ùå Sorry, something went wrong. Type *menu* to see our dishes or *hi* to start over.'
      );
    }
  }

  // Simple order parsing - just look for numbers and dish names
  static async parseSimpleOrder(message) {
    try {
      const dishes = await Dish.find({ available: true });
      const orderItems = [];
      const words = message.toLowerCase().split(/\s+/);

      console.log('üîç Parsing:', message);
      console.log('üìã Available dishes:', dishes.map(d => d.name));

      // Look for patterns like "2 pizza", "1 margherita", etc.
      for (let i = 0; i < words.length; i++) {
        const word = words[i];
        const quantity = parseInt(word);

        if (!isNaN(quantity) && quantity > 0) {
          // Look for dish name in next few words
          for (let j = i + 1; j < Math.min(i + 4, words.length); j++) {
            const dishName = words.slice(i + 1, j + 1).join(' ');
            
            // Find matching dish (flexible matching)
            const matchingDish = dishes.find(dish => {
              const dishLower = dish.name.toLowerCase();
              return dishLower.includes(dishName) || 
                     dishName.includes(dishLower) ||
                     dishLower.includes(dishName.replace(/s$/, '')) || // handle plurals
                     SimpleOrderBot.fuzzyMatch(dishLower, dishName);
            });

            if (matchingDish) {
              console.log(`‚úÖ Found: ${quantity} x ${matchingDish.name}`);
              
              // Check if already in order
              const existing = orderItems.find(item => item.name === matchingDish.name);
              if (existing) {
                existing.quantity += quantity;
              } else {
                orderItems.push({
                  name: matchingDish.name,
                  quantity: quantity,
                  price: matchingDish.price
                });
              }
              break;
            }
          }
        }
      }

      // Also try without numbers (assume quantity 1)
      if (orderItems.length === 0) {
        for (const dish of dishes) {
          const dishLower = dish.name.toLowerCase();
          if (message.includes(dishLower) || 
              message.includes(dishLower.replace(/s$/, '')) ||
              SimpleOrderBot.fuzzyMatch(dishLower, message)) {
            
            console.log(`‚úÖ Found (qty 1): ${dish.name}`);
            orderItems.push({
              name: dish.name,
              quantity: 1,
              price: dish.price
            });
            break; // Only match first dish to avoid confusion
          }
        }
      }

      console.log('üì¶ Parsed items:', orderItems);
      return orderItems;

    } catch (error) {
      console.error('Error parsing order:', error);
      return [];
    }
  }

  // Simple fuzzy matching
  static fuzzyMatch(dishName, userInput) {
    // Remove common words and check similarity
    const cleanDish = dishName.replace(/pizza|burger|coke|drink/g, '').trim();
    const cleanInput = userInput.replace(/pizza|burger|coke|drink/g, '').trim();
    
    if (cleanDish && cleanInput) {
      return cleanDish.includes(cleanInput) || cleanInput.includes(cleanDish);
    }
    return false;
  }

  // Handle order - create and ask for details
  static async handleOrder(phoneNumber, orderItems) {
    try {
      const totalAmount = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      // Create or update WhatsApp order
      let whatsappOrder = await WhatsAppOrder.findOne({
        phoneNumber,
        status: { $in: ['pending_details', 'pending_payment'] }
      });

      if (!whatsappOrder) {
        whatsappOrder = new WhatsAppOrder({
          phoneNumber,
          items: orderItems,
          totalAmount,
          status: 'pending_details'
        });
      } else {
        whatsappOrder.items = orderItems;
        whatsappOrder.totalAmount = totalAmount;
      }

      await whatsappOrder.save();

      // Send order confirmation
      let message = `üõí *Your Order*\n\n`;
      orderItems.forEach(item => {
        message += `‚Ä¢ ${item.name} √ó ${item.quantity} = ‚Çπ${item.price * item.quantity}\n`;
      });
      message += `\nüí∞ *Total: ‚Çπ${totalAmount}*\n\n`;
      message += `üìù Please send your details:\n`;
      message += `Format: Name, Phone, Address\n\n`;
      message += `Example: John Doe, 9876543210, Mumbai\n\n`;
      message += `Or reply *cancel* to cancel this order`;

      await WhatsAppService.sendMessage(phoneNumber, message);

    } catch (error) {
      console.error('Error handling order:', error);
      await WhatsAppService.sendMessage(phoneNumber, '‚ùå Error processing order. Please try again.');
    }
  }

  // Send menu
  static async sendMenu(phoneNumber) {
    try {
      const dishes = await Dish.find({ available: true }).sort({ name: 1 });
      
      if (dishes.length === 0) {
        return await WhatsAppService.sendMessage(phoneNumber, '‚ùå No dishes available right now.');
      }

      let message = `üçΩÔ∏è *OrderEase Menu*\n\n`;
      dishes.forEach((dish, index) => {
        message += `${index + 1}. *${dish.name}* - ‚Çπ${dish.price}\n`;
        if (dish.description) {
          message += `   _${dish.description}_\n`;
        }
        message += `\n`;
      });

      message += `üìù *How to order:*\n`;
      message += `‚Ä¢ "2 pizza"\n`;
      message += `‚Ä¢ "1 margherita pizza"\n`;
      message += `‚Ä¢ "burger and coke"\n\n`;
      message += `Just tell me what you want! üòä`;

      await WhatsAppService.sendMessage(phoneNumber, message);

    } catch (error) {
      console.error('Error sending menu:', error);
      await WhatsAppService.sendMessage(phoneNumber, '‚ùå Error loading menu. Please try again.');
    }
  }

  // Send welcome message
  static async sendWelcome(phoneNumber) {
    const message = `üëã *Welcome to OrderEase!*\n\n` +
      `üçΩÔ∏è Type *menu* to see our dishes\n` +
      `üìù Just tell me what you want to order\n` +
      `üîç Send Order ID to track your order\n\n` +
      `*Examples:*\n` +
      `‚Ä¢ "2 pizza"\n` +
      `‚Ä¢ "margherita pizza"\n` +
      `‚Ä¢ "burger and coke"\n\n` +
      `What would you like today? üòä`;

    await WhatsAppService.sendMessage(phoneNumber, message);
  }

  // Send help message
  static async sendHelp(phoneNumber) {
    const message = `ü§î I didn't understand that.\n\n` +
      `*Try:*\n` +
      `‚Ä¢ "menu" - See all dishes\n` +
      `‚Ä¢ "2 pizza" - Order 2 pizzas\n` +
      `‚Ä¢ "margherita" - Order margherita pizza\n` +
      `‚Ä¢ "track 20241031-001" - Track order\n\n` +
      `What would you like to order? üòä`;

    await WhatsAppService.sendMessage(phoneNumber, message);
  }

  // Handle order tracking
  static async handleTracking(phoneNumber, message) {
    try {
      let orderId = null;

      // Extract order ID
      const orderIdMatch = message.match(/(\d{8}-\d{3})/);
      if (orderIdMatch) {
        orderId = orderIdMatch[1];
      } else {
        return await WhatsAppService.sendMessage(
          phoneNumber,
          'üîç Please send your Order ID\n\nExample: 20241031-001'
        );
      }

      // Find order
      const order = await Order.findOne({ displayOrderId: orderId });
      if (!order) {
        return await WhatsAppService.sendMessage(
          phoneNumber,
          `‚ùå Order ${orderId} not found. Please check your Order ID.`
        );
      }

      // Send status
      const statusEmoji = {
        'queued': '‚è≥',
        'preparing': 'üë®‚Äçüç≥',
        'ready': '‚úÖ',
        'picked': 'üì¶'
      };

      const statusText = {
        'queued': 'Order Received',
        'preparing': 'Being Prepared',
        'ready': 'Ready for Pickup',
        'picked': 'Completed'
      };

      let trackMessage = `${statusEmoji[order.status]} *${statusText[order.status]}*\n\n`;
      trackMessage += `üìã Order ID: ${order.displayOrderId}\n`;
      trackMessage += `üë§ Customer: ${order.customer.name}\n\n`;
      
      trackMessage += `üçΩÔ∏è *Items:*\n`;
      order.items.forEach(item => {
        trackMessage += `‚Ä¢ ${item.name} √ó ${item.quantity}\n`;
      });

      const totalAmount = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      trackMessage += `\nüí∞ Total: ‚Çπ${totalAmount}`;

      await WhatsAppService.sendMessage(phoneNumber, trackMessage);

    } catch (error) {
      console.error('Error tracking order:', error);
      await WhatsAppService.sendMessage(phoneNumber, '‚ùå Error tracking order. Please try again.');
    }
  }

  // Handle customer details
  static async handleCustomerDetails(phoneNumber, message) {
    try {
      // Find pending order
      const whatsappOrder = await WhatsAppOrder.findOne({
        phoneNumber,
        status: 'pending_details'
      });

      if (!whatsappOrder) {
        return await WhatsAppService.sendMessage(phoneNumber, '‚ùå No pending order found. Please place a new order.');
      }

      if (message.toLowerCase().includes('cancel')) {
        await whatsappOrder.deleteOne();
        return await WhatsAppService.sendMessage(phoneNumber, '‚ùå Order cancelled. Type *menu* to start a new order.');
      }

      // Parse customer details
      const parts = message.split(',').map(part => part.trim());
      if (parts.length < 3) {
        return await WhatsAppService.sendMessage(
          phoneNumber,
          '‚ùå Please provide: Name, Phone, Address\n\nExample: John Doe, 9876543210, Mumbai'
        );
      }

      const [name, phone, address] = parts;

      // Update order with customer details
      whatsappOrder.customer = { name, phone, address };
      whatsappOrder.status = 'pending_payment';
      await whatsappOrder.save();

      // Create payment link (simplified)
      const paymentMessage = `‚úÖ *Details Confirmed!*\n\n` +
        `üë§ ${name}\n` +
        `üìû ${phone}\n` +
        `üìç ${address}\n\n` +
        `üí∞ Total: ‚Çπ${whatsappOrder.totalAmount}\n\n` +
        `üí≥ *Payment Link:*\n` +
        `[Payment will be integrated here]\n\n` +
        `For now, your order is confirmed! üéâ`;

      await WhatsAppService.sendMessage(phoneNumber, paymentMessage);

      // Create actual order in system
      await SimpleOrderBot.createMainOrder(whatsappOrder);

    } catch (error) {
      console.error('Error handling customer details:', error);
      await WhatsAppService.sendMessage(phoneNumber, '‚ùå Error processing details. Please try again.');
    }
  }

  // Create main order
  static async createMainOrder(whatsappOrder) {
    try {
      // Generate order ID
      const nowIST = moment().tz('Asia/Kolkata');
      const datePrefix = nowIST.format('YYYYMMDD');
      
      const todayStart = nowIST.clone().startOf('day');
      const todayEnd = nowIST.clone().endOf('day');
      const latestOrder = await Order.findOne({
        createdAt: { $gte: todayStart.toDate(), $lte: todayEnd.toDate() },
        displayOrderId: { $regex: `^${datePrefix}-` }
      }).sort({ displayOrderId: -1 });

      let nextNumber = 1;
      if (latestOrder && latestOrder.displayOrderId) {
        const match = latestOrder.displayOrderId.match(/-(\d{3})$/);
        if (match) {
          nextNumber = parseInt(match[1], 10) + 1;
        }
      }
      const displayOrderId = `${datePrefix}-${String(nextNumber).padStart(3, '0')}`;

      // Create main order
      const order = new Order({
        items: whatsappOrder.items,
        customer: whatsappOrder.customer,
        status: 'queued',
        displayOrderId: displayOrderId,
        source: 'whatsapp'
      });

      await order.save();

      // Update WhatsApp order
      whatsappOrder.mainOrderId = order._id;
      whatsappOrder.status = 'completed';
      await whatsappOrder.save();

      // Send confirmation
      const confirmMessage = `üéâ *Order Placed Successfully!*\n\n` +
        `üìã *Order ID:* ${displayOrderId}\n\n` +
        `Your order is now being prepared!\n` +
        `Track anytime by sending: ${displayOrderId}\n\n` +
        `Thank you for choosing OrderEase! üòä`;

      await WhatsAppService.sendMessage(whatsappOrder.phoneNumber, confirmMessage);

    } catch (error) {
      console.error('Error creating main order:', error);
    }
  }
}

module.exports = SimpleOrderBot;